# $Id: PKGBUILD 149143 2012-02-05 21:51:45Z dan $
# Maintainer: Dan McGee <dan@archlinux.org>
# Contributor: Evan LeCompte <evanlec@gmail.com>

pkgname=('munin' 'munin-node')
pkgbase=munin
pkgver=2.0.3
pkgrel=1
pkgdesc="A distributed monitoring/graphing tool"
arch=('any')
url="http://munin-monitoring.org/"
license=("GPL")
depends=('rrdtool' 'perl' 'perl-log-log4perl' 'perl-html-template' 'perl-date-manip' 'perl-io-socket-inet6' 'perl-file-copy-recursive')
source=(http://downloads.sourceforge.net/sourceforge/munin/munin-$pkgver.tar.gz
        Makefile.config
        keep-defaults.patch
        munin-lock-location.patch
        munin-cron-entry
        munin-node.init
        logrotate.munin
        logrotate.munin-node
        08-munin-font-dir.conf)

build() {
	cd "$srcdir/munin-$pkgver"
	# This build is beyond fucked, also need to report this upstream
	patch -Np0 < ../keep-defaults.patch
	patch -Np1 < ../munin-lock-location.patch

	sed -i -e 's#/sbin/ip6tables#/usr/sbin/ip6tables#' plugins/node.d.linux/ip_.in

	cp ../Makefile.config .
	# multithreading wrecks havoc on the build, should probably report this
	make -j1 PREFIX=''
}

package_munin() {
	depends=('perl' 'rrdtool' 'perl-html-template' 'perl-date-manip' 'perl-log-log4perl' 'munin-node')
	backup=(etc/munin/munin.conf etc/logrotate.d/munin)
	install=munin.install

	cd "$srcdir/munin-$pkgver"
	make DESTDIR="$pkgdir" install-master-prime
	install -D -m644 ../munin-cron-entry "$pkgdir"/etc/munin/munin-cron-entry
	install -D -m644 ../logrotate.munin "$pkgdir"/etc/logrotate.d/munin
	install -D -m644 ../08-munin-font-dir.conf "$pkgdir"/etc/fonts/conf.d/08-munin-font-dir.conf
	rm -rf "$pkgdir/var/run/"
}

package_munin-node() {
	depends=('perl' 'perl-net-server')
	optdepends=('perl-net-snmp: for SNMP plugins'
	            'perl-net-ssleay: for SSL/TLS support')
	backup=(etc/munin/munin-node.conf etc/logrotate.d/munin-node)
	install=munin-node.install

	cd "$srcdir/munin-$pkgver"
	make DESTDIR="$pkgdir" install-common-prime install-node-prime install-plugins-prime
	install -D -m755 ../munin-node.init "$pkgdir"/etc/rc.d/munin-node
	install -D -m644 ../logrotate.munin-node "$pkgdir"/etc/logrotate.d/munin-node
	rm -rf "$pkgdir/var/run/"
}

md5sums=('6b3d40c53baed5ead148f4e1a331e450'
         'f7a26c9a91f16b28cb7b72fc5af4e107'
         'ee8a2b61f01d8829546479e3f952ae7e'
         'd1a53ad3f541c92e35c39a609db2013b'
         'dc9c83aa2a278466fb475364462f4119'
         '683627bd0f0c0d1e146dde7d246b6b3c'
         'db77b53150a906256a71a9f539c7fac2'
         'cdf139f2b6ae36852113f3411caa6e99'
         'e33a45c3b80a83eecabbe5a9920c1eb6')
